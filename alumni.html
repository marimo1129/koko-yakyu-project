<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>卒業生一覧 | 高校野球</title>

  <!-- 共通スタイル -->
  <link rel="stylesheet" href="./assets/styles.css" />

  <!-- CSVを確実に読むためのライブラリ（先に読み込むのが超重要） -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <!-- 共通JS（ナビゲーションなど） -->
  <script defer src="./assets/app.js"></script>
</head>
<body>
  <header class="topbar">
    <div class="brand" onclick="goHome()">高校野球データポータル</div>
    <nav class="actions">
      <button class="btn ghost" onclick="goBack()">← 戻る</button>
      <a class="btn" href="./index.html">🏠 ホーム</a>
    </nav>
  </header>

  <main class="container">
    <h1>卒業生一覧</h1>

    <!-- 一覧を描画する場所 -->
    <section id="alumniList" class="grid"></section>
  </main>

  <footer class="footer">
    <button class="icon-btn" onclick="goBack()">← 戻る</button>
    <button class="icon-btn" onclick="goHome()">🏠 ホーム</button>
  </footer>

  <!-- ─────────────────────────────────────────────
       ここから “単独で動く描画スクリプト”
       app.js に依存せず、これだけで players.csv を表示します。
       うまく動いたら、あとで app.js に統合してOK。
  ───────────────────────────────────────────── -->
  <script>
  (async () => {
    try {
      // alumni.html がリポジトリ直下にある前提のパス
      // （もし /scripts/ 配下に置いているなら './data/...' を '../data/...' に変えてください）
      const CSV_PATH = './data/players.csv';

      const res = await fetch(CSV_PATH);
      if (!res.ok) throw new Error(`players.csv を取得できませんでした（HTTP ${res.status}）`);
      const text = await res.text();

      // PapaParseで確実にパース
      const rows = Papa.parse(text, { header: true, skipEmptyLines: true }).data;

      // 表示用に空行を除外
      const data = rows.filter(r => (r.player_name || '').trim());

      const list = document.querySelector('#alumniList');
      list.innerHTML = '';

      if (data.length === 0) {
        list.innerHTML = '<p class="muted">表示できる卒業生データが見つかりませんでした（players.csv を確認してください）。</p>';
        return;
      }

      // 各カードを描画
      data.forEach(r => {
        const card = document.createElement('article');
        card.className = 'card';

        // コメント（任意）
        const commentHtml = (r.comment && r.comment.trim())
          ? `<p class="muted" style="margin-top:6px">${r.comment}</p>`
          : '';

        card.innerHTML = `
          <div class="content">
            <h3 class="title">${r.player_name || '—'}（${r.grade || ''}年・${r.position || ''}）</h3>
            <p class="meta">${r.team_name || '—'}（${r.prefecture || ''}）</p>
            <p class="meta2">卒業年: ${r.graduation_year || '—'}｜進路: ${(r.dest_type||'—')}${r.dest_name ? '・'+r.dest_name : ''}</p>
            ${commentHtml}
          </div>
        `;

        // YouTube（watch?v= / youtu.be / embed すべて対応）
        const url = (r.youtube_url || '').trim();
        if (url) {
          const idMatch = url.match(/[?&]v=([\w-]{6,})|youtu\.be\/([\w-]{6,})|\/embed\/([\w-]{6,})/);
          const vid = idMatch ? (idMatch[1] || idMatch[2] || idMatch[3]) : '';
          if (vid) {
            const wrap = document.createElement('div');
            wrap.className = 'embed';
            wrap.innerHTML = `<iframe src="https://www.youtube.com/embed/${vid}" title="YouTube" frameborder="0" allowfullscreen loading="lazy"></iframe>`;
            card.querySelector('.content').appendChild(wrap);
          }
        }

        list.appendChild(card);
      });

      console.log('Alumni rendered:', data.length, 'rows');
    } catch (err) {
      console.error(err);
      const list = document.querySelector('#alumniList');
      list.innerHTML = `<p class="muted">エラー：${err.message}</p>`;
    }
  })();
  </script>
  <!-- ======== 強制診断つき 卒業生描画スクリプト ======== -->
<script>
(async () => {
  // 画面上に診断ログを出す小さい領域
  const logBox = document.createElement('pre');
  logBox.style.background = '#111';
  logBox.style.color = '#9aa4af';
  logBox.style.padding = '8px 12px';
  logBox.style.border = '1px solid #333';
  logBox.style.borderRadius = '8px';
  logBox.style.maxWidth = '960px';
  logBox.style.margin = '12px auto';
  logBox.style.fontSize = '12px';
  logBox.style.whiteSpace = 'pre-wrap';
  logBox.textContent = '診断ログ:\n';
  document.querySelector('main.container').insertBefore(logBox, document.querySelector('#alumniList'));

  const log = (...args) => { logBox.textContent += args.join(' ') + '\n'; console.log(...args); };

  try {
    // 3候補のパスを順番に試す（キャッシュバスター付き）
    const candidates = [
      './data/players.csv',
      '../data/players.csv',
      '/koko-yakyu-project/data/players.csv'
    ];

    let csvText = null;
    let usedPath = null;

    for (const base of candidates) {
      const url = base + (base.includes('?') ? '&' : '?') + 'v=' + Date.now();
      log('TRY:', url);
      try {
        const res = await fetch(url, { cache: 'no-store' });
        log('  status =', res.status, res.statusText);
        if (res.ok) {
          const txt = await res.text();
          log('  text(0..120)=', txt.slice(0, 120).replace(/\n/g, '\\n'));
          csvText = txt;
          usedPath = base;
          break;
        }
      } catch (e) {
        log('  fetch error:', e.message);
      }
    }

    if (!csvText) {
      throw new Error('CSVを取得できませんでした（3候補すべて失敗）');
    }

    log('USED PATH:', usedPath);

    // PapaParse でパース
    let parsed;
    try {
      parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true });
    } catch (e) {
      log('Papa.parse error:', e.message);
      throw e;
    }

    if (parsed.errors && parsed.errors.length) {
      log('Papa errors (先頭1件):', JSON.stringify(parsed.errors[0]));
    }

    const rows = Array.isArray(parsed.data) ? parsed.data : [];
    log('rows.length =', rows.length);
    const data = rows.filter(r => (r.player_name || '').trim());
    log('displayable =', data.length);

    const list = document.querySelector('#alumniList');
    list.innerHTML = '';

    if (data.length === 0) {
      list.innerHTML = '<p class="muted">表示できる卒業生データがありません（players.csv のヘッダ名と値を確認）。</p>';
      return;
    }

    // カード描画
    data.forEach(r => {
      const card = document.createElement('article');
      card.className = 'card';
      card.innerHTML = `
        <div class="content">
          <h3 class="title">${r.player_name || '—'}（${r.grade || ''}年・${r.position || ''}）</h3>
          <p class="meta">${r.team_name || '—'}（${r.prefecture || ''}）</p>
          <p class="meta2">卒業年: ${r.graduation_year || '—'}｜進路: ${(r.dest_type||'—')}${r.dest_name ? '・'+r.dest_name : ''}</p>
          ${(r.comment && r.comment.trim()) ? `<p class="muted" style="margin-top:6px">${r.comment}</p>` : ``}
        </div>
      `;

      // YouTube埋め込み
      const url = (r.youtube_url || '').trim();
      if (url) {
        const m = url.match(/[?&]v=([\w-]{6,})|youtu\.be\/([\w-]{6,})|\/embed\/([\w-]{6,})/);
        const vid = m ? (m[1] || m[2] || m[3]) : '';
        if (vid) {
          const wrap = document.createElement('div');
          wrap.className = 'embed';
          wrap.innerHTML = `<iframe src="https://www.youtube.com/embed/${vid}" title="YouTube" frameborder="0" allowfullscreen loading="lazy"></iframe>`;
          card.querySelector('.content').appendChild(wrap);
        }
      }

      list.appendChild(card);
    });

    log('RENDERED:', data.length, 'cards');
  } catch (e) {
    const list = document.querySelector('#alumniList');
    list.innerHTML = `<p class="muted">エラー：${e.message}</p>`;
    log('FATAL:', e.message);
  }
})();
</script>
<!-- ======== /診断つきスクリプト ======== -->

</body>
</html>
