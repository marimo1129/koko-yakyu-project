<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>秋季大会 ベスト8</title>
</head>
<body>
  <header>
    <h1>秋季大会 ベスト8（準々決勝出場校）</h1>
    <p>
      表示対象の年をクエリで変更できます：
      <code>?year=2025</code>（例）
    </p>
  </header>

  <main id="list"><p>読み込み中...</p></main>

  <script>
  // ?year=2025 のように指定（未指定なら 2025 にしています）
  const YEAR = new URLSearchParams(location.search).get("year") || "2025";
  const CSV  = `data/best8_autumn_${YEAR}.csv`;

  // とても簡単なCSVパーサ（カンマを含まない前提）
  function parseCSV(text) {
    const lines = text.trim().split(/\r?\n/);
    const head = lines[0].split(",");
    const idx  = Object.fromEntries(head.map((h, i) => [h, i]));
    return lines.slice(1).map(line => {
      const c = line.split(",");
      return {
        year: c[idx.year],
        prefecture: c[idx.prefecture],
        url: c[idx.url],
        qf: [
          c[idx.qf1], c[idx.qf2], c[idx.qf3], c[idx.qf4],
          c[idx.qf5], c[idx.qf6], c[idx.qf7], c[idx.qf8],
        ].filter(Boolean)
      };
    });
  }

  async function main() {
    try {
      const res  = await fetch(CSV, {cache: "no-store"});
      if (!res.ok) throw new Error(`CSV not found: ${CSV}`);
      const text = await res.text();
      const rows = parseCSV(text);
      render(rows);
    } catch (e) {
      document.getElementById("list").innerHTML =
        `<p style="color:#c00">CSVの読み込みに失敗しました：${e.message}</p>`;
    }
  }

  function render(data) {
    const wrap = document.getElementById("list");
    if (!data.length) {
      wrap.innerHTML = `<p>データがありません（${CSV}）。</p>`;
      return;
    }
    wrap.innerHTML = "";
    data.sort((a,b)=>a.prefecture.localeCompare(b.prefecture,"ja"));
    data.forEach(d => {
      const sec = document.createElement("section");
      sec.className = "card";
      sec.innerHTML = `
        <h2>${d.prefecture}</h2>
        <p class="src"><a href="${d.url}" target="_blank" rel="noopener">大会ページ</a></p>
        <ol class="grid">
          ${d.qf.map(n => `<li>${n || "-"}</li>`).join("")}
        </ol>
      `;
      wrap.appendChild(sec);
    });
  }

  main();
  </script>

  <style>
    :root{
      --bg:#0f0f12; --panel:#1b1d22; --border:#2a2d33; --text:#e9edf1; --muted:#aab3be; --link:#5aa8ff;
    }
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif}
    header{padding:24px 20px;border-bottom:1px solid var(--border)}
    h1{margin:0 0 6px;font-size:22px}
    code{background:var(--panel);padding:2px 6px;border-radius:6px;border:1px solid var(--border)}
    main{padding:16px 20px;max-width:1100px;margin:0 auto}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px;margin:12px 0;box-shadow:0 2px 6px rgba(0,0,0,.25)}
    .card h2{margin:0 0 6px;font-size:18px}
    .card .src{margin:0 0 10px}
    a{color:var(--link);text-decoration:none}
    a:hover{text-decoration:underline}
    .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:8px;padding-left:18px}
    li{background:#252932;border:1px solid var(--border);border-radius:8px;padding:8px;min-height:28px}
  </style>
<!-- === Players Scores (2025) === -->
<section id="players-scores" style="max-width:1000px;margin:40px auto;padding:16px;border:1px solid #eee;border-radius:12px">
  <h2 style="margin:0 0 12px">2025 注目選手スコア</h2>

  <div style="display:flex;gap:12px;align-items:center;margin:8px 0 16px">
    <label>学校で絞り込み：
      <select id="schoolFilter">
        <option value="">（全校）</option>
      </select>
    </label>
    <label>表示件数：
      <select id="limit">
        <option>10</option><option selected>20</option><option>50</option><option>100</option>
      </select>
    </label>
    <button id="reload">更新</button>
  </div>

  <div style="overflow:auto">
    <table id="scoresTable" style="width:100%;border-collapse:collapse">
      <thead>
        <tr>
          <th style="text-align:left;border-bottom:1px solid #ddd;padding:8px">学校</th>
          <th style="text-align:left;border-bottom:1px solid #ddd;padding:8px">選手</th>
          <th style="text-align:left;border-bottom:1px solid #ddd;padding:8px">守備</th>
          <th style="text-align:right;border-bottom:1px solid #ddd;padding:8px">AIスコア</th>
          <th style="text-align:left;border-bottom:1px solid #ddd;padding:8px">根拠</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</section>

<script>
// ざっくりCSVパーサ（カンマを含むダブルクォート対応）
function parseCSV(text){
  const rows = [];
  let cur = '', row = [], inside = false;
  for (let i=0;i<text.length;i++){
    const c = text[i], n = text[i+1];
    if (c === '"' && n === '"'){ cur += '"'; i++; continue; }
    if (c === '"'){ inside = !inside; continue; }
    if (c === ',' && !inside){ row.push(cur); cur=''; continue; }
    if ((c === '\n' || c === '\r') && !inside){
      if (cur!=='' || row.length){ row.push(cur); rows.push(row); row=[]; cur=''; }
      continue;
    }
    cur += c;
  }
  if (cur!=='' || row.length){ row.push(cur); rows.push(row); }
  return rows;
}

async function loadScores(){
  const res = await fetch('data/player_scores_2025.csv'); // ここを年ごとに変える
  const text = await res.text();
  const rows = parseCSV(text).filter(r => r.length && r.some(x=>x.trim()!==''));
  const header = rows[0].map(h=>h.trim());
  const data = rows.slice(1).map(r=>{
    const obj = {};
    header.forEach((h,idx)=>obj[h]=r[idx] ?? '');
    return obj;
  });

  // 欄名の想定（collect_players.py の出力に合わせています）
  // year,school_name,player_name,position,AI_score,basis など
  // 数値化
  data.forEach(d => d.AI_score = parseFloat(d.AI_score || d.ai_score || d.score || 0));

  // 学校プルダウンを作成
  const schools = Array.from(new Set(data.map(d=>d.school_name).filter(Boolean))).sort();
  const sel = document.getElementById('schoolFilter');
  sel.innerHTML = '<option value="">（全校）</option>' + schools.map(s=>`<option>${s}</option>`).join('');

  // 表示処理
  function render(){
    const limit = parseInt(document.getElementById('limit').value,10) || 20;
    const filter = sel.value.trim();
    const tbody = document.querySelector('#scoresTable tbody');
    let filtered = data.slice();
    if (filter) filtered = filtered.filter(d => d.school_name === filter);
    filtered.sort((a,b)=> (b.AI_score||0) - (a.AI_score||0));
    const rowsHTML = filtered.slice(0, limit).map(d=>`
      <tr>
        <td style="padding:8px;border-bottom:1px solid #f0f0f0">${d.school_name||''}</td>
        <td style="padding:8px;border-bottom:1px solid #f0f0f0">${d.player_name||''}</td>
        <td style="padding:8px;border-bottom:1px solid #f0f0f0">${d.position||''}</td>
        <td style="padding:8px;border-bottom:1px solid #f0f0f0;text-align:right">${(d.AI_score??'').toString()}</td>
        <td style="padding:8px;border-bottom:1px solid #f0f0f0">${d.basis||d.Basis||''}</td>
      </tr>`).join('');
    tbody.innerHTML = rowsHTML || `<tr><td colspan="5" style="padding:12px;color:#888">データがありません</td></tr>`;
  }

  document.getElementById('reload').onclick = render;
  document.getElementById('limit').onchange = render;
  sel.onchange = render;

  render();
}
loadScores();
</script>

</body>
</html>
